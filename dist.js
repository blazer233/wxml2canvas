const t={TOP:"top",width:340,FONT_SIZE:"14",PADDING:"0 0 0 0",FONT_COL:"#454545",SHADOW_COL:"#ffffff",background:"#ffffff",font:"14px PingFang SC"},e={},o=["width","height","font","fontSize","fontFamily","fontWeight","fontStyle","textAlign","color","lineHeight","border","borderColor","borderStyle","borderWidth","verticalAlign","boxShadow","background","backgroundColor","backgroundImage","backgroundPosition","backgroundSize","paddingLeft","paddingTop","paddingRight","paddingBottom"],n=t=>isNaN(t)?+(t||"").replace("px",""):t,i=t=>{let e;return t.lineHeight=`${t.lineHeight||""}`,e=+t.lineHeight.replace("px",""),e=e||1.2*(t.fontSize||14),e},l=(t,o)=>{const{ctx:n}=e;o&&(n.font=o);const i=n.measureText(t)||{};return Math.floor(i.width||0)},r=(t,o,n,l,r=0)=>{const{options:a}=e,s=i(o),d=Math.ceil(o.fontSize||a.FONT_SIZE),f=(o.dataset&&o.dataset.type||"").indexOf("inline")>-1?0:(s-d)/2,c=o.padding&&o.padding[0]||0,p=o.textAlign||"left";let h=t.x;"center"===p&&(h=(l-n)/2+t.x),"right"===p&&(h=l-n+t.x);return[h+(o.padding&&o.padding[3]||0),t.y+f+r*s+c]},a=(t,o,n,i,l)=>{const{fill:r}=l,{ctx:a,options:s}=e;a.save(),a.setShadow(0,0,0,s.SHADOW_COL),a.setFillStyle(r),a.fillRect(t,o,n,i),a.draw(!0),a.restore()},s=(t,e,o,n=0,i=0)=>{let r=0,a=n+o+r,s=t.substring(n,a),d=l(s);for(;Math.round(i+d)>e;)r-=1,a=n+o+r,s=t.substring(n,a),d=l(s);return[a,s,d]},d=(t,o,d,f,c="text")=>{const{ctx:p}=e;let h=0,g=0;try{(t=>{const{ctx:o,options:i}=e;t.fontSize=n(t.fontSize);const l=Math.ceil(t.fontSize||i.FONT_SIZE);o.setTextBaseline("top"),o.font=((t,e)=>`${t.fontWeight?t.fontWeight:"normal"} ${e}px ${t.fontFamily||"PingFang SC"}`)(t,l),o.setFillStyle(t.color||i.FONT_COL)})(o);let f=t.text||"",x=l(f,o.font||p.font);const u=i(o),b=Math.ceil(x/(o.width||x))*u;let m=Math.ceil(o.width||x),w=0,S=0;if((o.background||o.border)&&((t,e,o,n)=>{if(!e.width)return;let i=e.width||o,l=e.height||n;const r={fill:e.background,border:e.border};i+=(e.padding[1]||0)+(e.padding[3]||0),l+=(e.padding[0]||0)+(e.padding[2]||0),a(t.x,t.y,i,l,r)})(t,o,x,b),"inline-text"===c){const e=t.maxWidth;if(t.leftOffset+x>e){let n=Math.max(Math.floor(x/e),1);const i=f.length,a=Math.floor(i/n),d=t.leftOffset-t.originX;let[c,b,m]=s(f,e,a,0,d);[w,S]=r(t,o,m),p.fillText(b,w,S),h=w+m,g=S,f=f.substring(c,f.length),c=0,n=Math.max(Math.floor(x/e),1),x=l(f,o.font||p.font),t.x=t.originX;for(let i=0;i<n;i++){const[l,d,x]=s(f,e,a,c);c=l,d&&([w,S]=r(t,o,x,e,i+1),p.fillText(d,w,S),i===n-1&&(h=w+x,g=u*n))}let O=f.substring(c,i),y=l(O);O&&([w,S]=r(t,o,x,e,n+1),p.fillText(O,w,S),h=w+y,g=u*(n+1))}else[w,S]=r(t,o,x,e),p.fillText(t.text,w,S),h=w+x,g=u}else[w,S]=r(t,o,x,m),p.fillText(t.text,w,S);if(p.draw(!0),!d)return{leftOffset:h,topOffset:g};d()}catch(t){f&&f({errcode:1004,errmsg:"drawText error",e:t})}},f=(t=[])=>t.map((t=>new Promise(((e,o)=>{const n=p(t);d(n,t,e,o,"text")})))),c=(t={})=>{let e=0;return new Promise((o=>{let n=0,i=1/0,l=-1/0;Object.keys(t).forEach((e=>{t[e].forEach((t=>{i=Math.min(t.left,i),l=Math.max(t.right,l)}))})),n=Math.ceil(l-i),Object.keys(t).forEach((o=>{t[o].forEach((t=>{const o=p(t,e,n),i=d(o,t,null,null,"inline-text");e=i.leftOffset}))})),o()}))},p=(t,e,o)=>{h(t);const n=t.dataset.text||"";return t.background=t.dataset.background||t.backgroundColor,{text:n,x:e||t.left,y:t.top,originX:t.left,...e&&{leftOffset:e},...o&&{maxWidth:o}}},h=t=>{const{options:o}=e,{left:i=0,top:l=0}=o.limit,r=+t.dataset.left||0,a=+t.dataset.top||0;t.width=n(t.width),t.height=n(t.height),t.left=n(t.left)-i+r,t.top=n(t.top)-l+a;let s=t.dataset.padding||o.PADDING;"string"==typeof s&&(s=((t=e.options.PADDING)=>{for(let e=0,o=(t=t.split(" ")).length;e<o;e++)t[e]=+t[e].replace("px","");return t})(s));const d=+t.paddingTop.replace("px","")+ +s[0],f=+t.paddingRight.replace("px","")+ +s[1],c=+t.paddingBottom.replace("px","")+ +s[2],p=+t.paddingLeft.replace("px","")+ +s[3];t.padding=[d,f,c,p]};var g=n=>new Promise((async(i,l)=>{const r=((o={})=>{const n={...t,...o};return e.options=n,e.ctx=wx.createCanvasContext(n.element,n.obj),t=>Object.keys(t).forEach((o=>e.options[o]=t[o]))})(n);(()=>{const{ctx:t,options:o}=e,{background:n,font:i,width:l,height:r}=o;t.font=i,t.setTextBaseline("top"),t.setStrokeStyle("white"),a(0,0,l,r,{fill:n})})();const s=n.options,[d,p]=await(t=>{const{options:n}=e,{obj:i,width:l}=n,r=i?wx.createSelectorQuery().in(i):wx.createSelectorQuery(),a=new Promise((e=>{r.selectAll(t.class).fields({dataset:!0,size:!0,rect:!0,computedStyle:o},(t=>e(t))).exec()})),s=new Promise((e=>{t.limit||e({top:0,width:l}),r.select(t.limit).fields({dataset:!0,size:!0,rect:!0},(t=>e(t))).exec()}));return Promise.all([a,s])})(s),[h,g]=(t=>{const[e,o,n]=[[],[],{}];return t.forEach((t=>{t.dataset.type&&-1==t.dataset.type.indexOf("inline")?e.push(t):o.push(t)})),o.forEach((t=>{n[t.top]=n[t.top]||[],n[t.top].push(t)})),[e,n]})(d);r({limit:p});const x=[...f(h),c(g)];Promise.all(x).then(i).catch(l)}));export{g as default};