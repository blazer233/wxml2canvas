const t=t=>isNaN(t)?+(t||"").replace("px",""):t,e=t=>{let e;return t.lineHeight=`${t.lineHeight||""}`,e=+t.lineHeight.replace("px",""),e=e||1.2*(t.fontSize||14),e},o=(t,e)=>{const{ctx:o}=a;e&&(o.font=e);const i=o.measureText(t)||{};return Math.floor(i.width||0)},i=(t,o,i,n,l=0)=>{const{options:r}=a,s=e(o),f=Math.ceil(o.fontSize||r.FONT_SIZE),d=o.dataset&&o.dataset.type.indexOf("inline")>-1?0:(s-f)/2,c=o.padding&&o.padding[0]||0,h=o.textAlign||"left";let p=t.x;"center"===h&&(p=(n-i)/2+t.x),"right"===h&&(p=n-i+t.x);return[p+(o.padding&&o.padding[3]||0),t.y+d+l*s+c]},n=(t,e,o,i,n)=>{const{fill:l}=n,{ctx:r,options:s}=a;r.save(),r.setShadow(0,0,0,s.SHADOW_COL),r.setFillStyle(l),r.fillRect(t,e,o,i),r.draw(!0),r.restore()},l={width:340,TOP:"top",FONT_SIZE:"14",PADDING:"0 0 0 0",FONT_COL:"#454545",SHADOW_COL:"#ffffff",background:"#ffffff",font:"14px PingFang SC",STROKECOLOR:"white"},a={},r=["width","height","font","fontSize","fontFamily","fontWeight","fontStyle","textAlign","color","lineHeight","border","borderColor","borderStyle","borderWidth","verticalAlign","boxShadow","background","backgroundColor","backgroundImage","backgroundPosition","backgroundSize","paddingLeft","paddingTop","paddingRight","paddingBottom"],s=(t,e,i,n=0,l=0)=>{let a=0,r=n+i+a,s=t.substring(n,r),f=o(s);for(;Math.round(l+f)>e;)a-=1,r=n+i+a,s=t.substring(n,r),f=o(s);return console.log(r,s,f),[r,s,f]},f=(l,r,f,d,c)=>{const{ctx:h,options:p}=a;let g=0,x=0;try{r.fontSize=t(r.fontSize);const a=Math.ceil(r.fontSize||p.FONT_SIZE);h.setTextBaseline("top"),h.font=((t,e)=>`${t.fontWeight?t.fontWeight:"normal"} ${e}px ${t.fontFamily||"PingFang SC"}`)(r,a),h.setFillStyle(r.color||p.FONT_COL);let c=l.text||"",u=o(c,r.font||h.font);const O=e(r),b=Math.ceil(u/(r.width||u))*O;let m=Math.ceil(r.width||u),S=0,w=0;if((r.background||r.border)&&((t,e,o,i)=>{if(!e.width)return;let l=e.width||o,a=e.height||i;const r={fill:e.background,border:e.border};l+=(e.padding[1]||0)+(e.padding[3]||0),a+=(e.padding[0]||0)+(e.padding[2]||0),n(t.x,t.y,l,a,r)})(l,r,u,b),"inline"===f){const t=l.maxWidth;if(l.leftOffset+u>t){let e=Math.max(Math.floor(u/t),1);const n=c.length,a=Math.floor(n/e),f=l.leftOffset-l.originX;let[d,p,b]=s(c,t,a,0,f);[S,w]=i(l,r,b),h.fillText(p,S,w),g=S+b,x=w,c=c.substring(d,c.length),d=0,e=Math.max(Math.floor(u/t),1),u=o(c,r.font||h.font),l.x=l.originX;for(let o=0;o<e;o++){const[n,f,p]=s(c,t,a,d);d=n,f&&([S,w]=i(l,r,p,t,o+1),h.fillText(f,S,w),o===e-1&&(g=S+p,x=O*e))}let m=c.substring(d,n),y=o(m);m&&([S,w]=i(l,r,u,t,e+1),h.fillText(m,S,w),g=S+y,x=O*(e+1))}else[S,w]=i(l,r,u,t),h.fillText(l.text,S,w),g=S+u,x=O}else[S,w]=i(l,r,u,m),h.fillText(l.text,S,w);if(h.draw(!0),!d)return{leftOffset:g,topOffset:x};d()}catch(t){c&&c(t)}},d=(t=[])=>t.map((t=>new Promise(((e,o)=>{const i=h(t);f(i,t,"text",e,o)})))),c=(t={})=>{let e=0;return new Promise((o=>{let i=0,n=1/0,l=-1/0;Object.keys(t).forEach((e=>{t[e].forEach((t=>{n=Math.min(t.left,n),l=Math.max(t.right,l)}))})),i=Math.ceil(l-n),Object.keys(t).forEach((o=>{t[o].forEach((t=>{const o=h(t,e,i),n=f(o,t,"inline");e=n.leftOffset}))})),o()}))},h=(e,o,i)=>{const{options:n}=a,{left:l=0,top:r=0}=n.limit,s=+e.dataset.left||0,f=+e.dataset.top||0;e.width=t(e.width),e.height=t(e.height),e.left=t(e.left)-l+s,e.top=t(e.top)-r+f;let d=e.dataset.padding||n.PADDING;"string"==typeof d&&(d=((t=a.options.PADDING)=>{for(let e=0,o=(t=t.split(" ")).length;e<o;e++)t[e]=+t[e].replace("px","");return t})(d));const c=+e.paddingTop.replace("px","")+ +d[0],h=+e.paddingRight.replace("px","")+ +d[1],p=+e.paddingBottom.replace("px","")+ +d[2],g=+e.paddingLeft.replace("px","")+ +d[3];e.padding=[c,h,p,g];const x=e.dataset.text||"";return e.background=e.dataset.background||e.backgroundColor,{text:x,x:o||e.left,y:e.top,originX:e.left,...o&&{leftOffset:o},...i&&{maxWidth:i}}};var p=t=>new Promise((async(e,o)=>{const i=((t={})=>{const e={...l,...t},{background:o,font:i,width:r,height:s,TOP:f,STROKECOLOR:d}=e;return a.options=e,a.ctx=wx.createCanvasContext(e.element,e._this),a.ctx.font=i,a.ctx.setTextBaseline(f),a.ctx.setStrokeStyle(d),n(0,0,r,s,{fill:o}),t=>Object.keys(t).forEach((e=>a.options[e]=t[e]))})(t),[s,f]=await(t=>{const{options:e}=a,{_this:o,width:i}=e,n=o?wx.createSelectorQuery().in(o):wx.createSelectorQuery(),l=new Promise((e=>{n.selectAll(t.class).fields({dataset:!0,size:!0,rect:!0,computedStyle:r},(t=>e(t))).exec()})),s=new Promise((e=>{t.limit||e({top:0,width:i}),n.select(t.limit).fields({dataset:!0,size:!0,rect:!0},(t=>e(t))).exec()}));return Promise.all([l,s])})(t.options);i({limit:f});const[h,p]=(t=>{const[e,o,i]=[[],[],{}];return t.forEach((t=>{t.dataset.type&&-1==t.dataset.type.indexOf("inline")?e.push(t):o.push(t)})),o.forEach((t=>{i[t.top]=i[t.top]||[],i[t.top].push(t)})),[e,i]})(s);Promise.all([...d(h),c(p)]).then(e).catch(o)}));export{p as default};